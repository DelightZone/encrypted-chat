<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encrypted Chat</title>
  <link rel="icon" type="image/x-icon" href="../icon.png">
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  <style>
	  :root {
		--bg-color: #121212;
		--card-bg: #1e1e1e;
		--text-color: #ffffff;
		--accent-color: #4fc3f7;
		--input-bg: #2c2c2c;
		--border-color: #333;
		--scrollbar-bg: #2a2a2a;
		--scrollbar-thumb: #555;
	  }

	  * {
		box-sizing: border-box;
	  }

	body {
	  margin: 0;
	  font-family: 'Segoe UI', sans-serif;
	  background-color: var(--bg-color);
	  color: var(--text-color);
	  display: flex;
	  flex-direction: column;
	  overflow: hidden;
	  height: 100%;
	}

	  header {
		position: sticky;
		top: 0;
		background-color: var(--card-bg);
		padding: 10px 20px;
		display: flex;
		justify-content: space-between;
		align-items: center;
		z-index: 999;
		border-bottom: 1px solid var(--border-color);
	  }

	  header h1 {
		margin: 0;
		color: var(--accent-color);
		font-size: 1.2em;
	  }

	  #menuToggle {
		background: none;
		color: var(--accent-color);
		border: none;
		font-size: 1.2em;
		cursor: pointer;
	  }

	  #settingsMenu {
		display: none;
		position: absolute;
		top: 60px;
		right: 20px;
		background-color: var(--card-bg);
		border: 1px solid var(--border-color);
		border-radius: 10px;
		padding: 15px;
		z-index: 100;
	  }

	  #settingsMenu label {
		display: block;
		margin-bottom: 10px;
		font-size: 0.9em;
	  }

		#main {
		  height: calc(var(--vh, 1vh) * 100);
		  display: flex;
		  flex-direction: column;
		  overflow: hidden;
		  position: relative;
		}

	  #chatArea {
		flex: 1;
		overflow-y: auto;
		padding: 10px 20px 20px 20px;
		scroll-behavior: smooth;
		height: 100%;
	  }
	  
	  #chatArea {
		display: flex;
		flex-direction: column-reverse; /* ← this is the magic */
		overflow-y: auto;
		padding: 20px;
		scroll-behavior: smooth;
	  }

	  #chatArea::-webkit-scrollbar {
		width: 8px;
	  }

	  #chatArea::-webkit-scrollbar-thumb {
		background: var(--scrollbar-thumb);
		border-radius: 4px;
	  }

	  #chat {
		list-style: none;
		padding: 0;
		margin: 0;
	  }

	  #chat li {
		margin-bottom: 20px;
		display: flex;
		align-items: flex-start;
		gap: 10px;
	  }

	  #chat img {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		flex-shrink: 0;
	  }

	  .message-wrapper {
		display: flex;
		flex-direction: column;
		max-width: 80%;
	  }

	  .message-name {
		font-weight: bold;
		color: var(--accent-color);
		margin-bottom: 4px;
		word-break: break-word;
	  }

	  .message-content {
		white-space: pre-wrap;
		background: #2a2a2a;
		padding: 10px 15px;
		border-radius: 10px;
		font-size: 0.95em;
		line-height: 1.5;
		word-break: break-word;
	  }

	  #inputArea {
		display: flex;
		padding: 10px 20px;
		background-color: var(--card-bg);
		gap: 10px;
		align-items: center;
		border-top: 1px solid var(--border-color);
	  }

	  #msg {
		flex: 1;
		resize: none;
		height: 50px;
		background-color: var(--input-bg);
		color: var(--text-color);
		border: 1px solid var(--border-color);
		border-radius: 20px;
		padding: 12px 16px;
		font-size: 1em;
		line-height: 1.4;
		overflow-y: auto;
	  }

	  #msg::placeholder {
		color: #aaa;
	  }

	  button {
		background-color: var(--accent-color);
		color: #000;
		border: none;
		border-radius: 20px;
		padding: 12px 20px;
		font-weight: bold;
		font-size: 1em;
		cursor: pointer;
		transition: background 0.3s;
	  }

	  button:hover {
		background-color: #0288d1;
	  }

	  #autoscrollToggleLabel {
		display: flex;
		align-items: center;
		gap: 5px;
		font-size: 0.9em;
	  }

	  /* Responsive tweaks */
	  @media (max-width: 600px) {
		header h1 {
		  font-size: 1em;
		}

		#chat img {
		  width: 32px;
		  height: 32px;
		}

		.message-content {
		  font-size: 0.9em;
		}

		button {
		  padding: 10px 16px;
		  font-size: 0.9em;
		}
	  }
	  
	  input,textarea,button,select {
		  font-size: 16px; /* prevents iOS zoom on focus */
	  }
	  
	  html {
		height: 100%;
	  }
	</style>
</head>
<body>
  <header>
    <h1>✨ Encrypted Chat</h1>
    <button id="menuToggle">Menu</button>
    <div id="settingsMenu">
      <label>Nickname: <input id="nickname" placeholder="Your name" /></label>
      <label>Profile Pic URL: <input id="pfp" placeholder="https://..." /></label>
      <label>Secret Key: <input id="secret" placeholder="Encryption key" /></label>
      <label><input type="checkbox" id="audioToggle" checked> Audio Notifications</label>
      <label id="autoscrollToggleLabel"><input type="checkbox" id="autoscrollToggle" checked> Auto-scroll to newest</label>
      <button id="createRoom">Create New Room</button>
      <p>Room ID: <span id="roomDisplay">loading...</span></p>
    </div>
  </header>

  <div id="main">
    <div id="chatArea">
      <ul id="chat"></ul>
    </div>
    <div id="inputArea">
      <textarea id="msg" placeholder="Type a message..."></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <audio id="ping" src="../alert-pop.mp3" preload="auto" playsinline></audio>

  <script>
	window.onload = () => scrollToBottom(true);
    // -- Read room ID from URL or generate new
    const urlParams = new URLSearchParams(window.location.search);
    let room = urlParams.get('room');
    if (!room) {
      room = Math.random().toString(36).substring(2, 10);
      window.location.search = `?room=${room}`;
    }
    document.getElementById('roomDisplay').textContent = room;

    // -- Setup Pusher
    const pusher = new Pusher('e10c1ec0ce48bfccc178', {
      cluster: 'eu',
    });
    const channel = pusher.subscribe(`room-${room}`);

    channel.bind('message', async function (data) {
      try {
        const secret = document.getElementById('secret').value;
        if (!secret) return;

        const decrypted = await decryptMessage(data.encrypted, secret);
        const parsed = JSON.parse(decrypted);
		const li = document.createElement('li');
		li.innerHTML = `
		  <img src="${parsed.pfp}" width="32" style="vertical-align:middle;">
		  <div class="message-wrapper">
			<span class="message-name">${parsed.nickname}</span>
			<div class="message-content">${parsed.text.replace(/\n/g, '<br>')}</div>
		  </div>`;
		document.getElementById('chat').appendChild(li);
		scrollToBottom(); // ✅ this triggers auto-scroll based on toggle
		playNotification(); // optional: put this here too, if needed
      } catch (e) {
        console.warn("Decryption failed or wrong key");
      }
    });

    // -- Handle sending
    document.getElementById('send').onclick = async () => {
      const text = document.getElementById('msg').value;
      const nickname = document.getElementById('nickname').value || "Anonymous";
      const pfp = document.getElementById('pfp').value || "https://placehold.co/32";
      const secret = document.getElementById('secret').value;

      if (!text || !secret) return;

      const payload = { text, nickname, pfp };
      const encrypted = await encryptMessage(JSON.stringify(payload), secret);

      await fetch('/.netlify/functions/pusher-signal', {
        method: 'POST',
        body: JSON.stringify({
          room,
          message: encrypted
        })
      });
      document.getElementById('msg').value = '';
    };

    // -- Room creation
    document.getElementById('createRoom').onclick = () => {
      const newRoom = Math.random().toString(36).substring(2, 10);
      window.location.search = `?room=${newRoom}`;
    };

    // -- Encryption utils
    async function encryptMessage(message, password) {
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password);
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        enc.encode(message)
      );
      return btoa([...iv, ...new Uint8Array(encrypted)].map(b => String.fromCharCode(b)).join(''));
    }

    async function decryptMessage(encoded, password) {
      const data = atob(encoded).split('').map(c => c.charCodeAt(0));
      const iv = new Uint8Array(data.slice(0, 12));
      const encrypted = new Uint8Array(data.slice(12));
      const key = await deriveKey(password);
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        encrypted
      );
      return new TextDecoder().decode(decrypted);
    }

    async function deriveKey(password) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: enc.encode("fixed_salt"), // Replace with dynamic salt if needed
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }
    const chat = document.getElementById('chat');
    const chatArea = document.getElementById('chatArea');
    const ping = document.getElementById('ping');
    const msgInput = document.getElementById('msg');

    document.getElementById('menuToggle').onclick = () => {
      const menu = document.getElementById('settingsMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    };

    function scrollToBottom(force = false) {
      const autoScroll = document.getElementById('autoscrollToggle').checked;
      if (autoScroll || force) {
        chatArea.scrollTop = chatArea.scrollHeight;
      }
    }

	function playNotification() {
	  const toggle = document.getElementById('audioToggle');
	  if (toggle.checked && !document.hasFocus()) {
		ping.play().catch(err => console.warn("Audio play failed:", err));
	  }
	}

    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send').click();
      }
    });
	
	document.addEventListener('click', () => {
	  ping.play().then(() => ping.pause()).catch(() => {});
	}, { once: true });
	
	  function setVH() {
		const vh = window.innerHeight * 0.01;
		document.documentElement.style.setProperty('--vh', `${vh}px`);
	  }
	  window.addEventListener('resize', setVH);
	  window.addEventListener('load', setVH);
  
	window.addEventListener('resize', setVH);
	window.addEventListener('load', setVH);
  </script>
</body>
</html>
