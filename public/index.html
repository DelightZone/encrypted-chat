<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encrypted Chat</title>
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  <style>
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #ffffff;
      --accent-color: #4fc3f7;
      --input-bg: #2c2c2c;
      --border-color: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
    }

    h1, h2 {
      color: var(--accent-color);
    }

    .card {
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    input, textarea, button {
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      margin-top: 5px;
      width: 100%;
    }

    button {
      cursor: pointer;
      background-color: var(--accent-color);
      color: #000;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #0288d1;
    }

    #chat {
      list-style: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    #chat li {
      padding: 8px;
      margin-bottom: 5px;
      background: #2a2a2a;
      border-radius: 8px;
    }

    #chat img {
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <h1>âœ¨ Encrypted Chat</h1>

  <div class="card">
    <label>Nickname: <input id="nickname" placeholder="Your name" /></label><br>
    <label>Profile Pic URL: <input id="pfp" placeholder="https://..." /></label><br>
    <label>Secret Key: <input id="secret" type="password" placeholder="Encryption key" /></label>
  </div>

  <div class="card">
    <button id="createRoom">Create New Room</button>
    <p>Room ID: <span id="roomDisplay">loading...</span></p>
  </div>

  <div class="card">
    <textarea id="msg" placeholder="Type a message..." rows="3"></textarea>
    <button id="send">Send</button>
  </div>

  <div class="card">
    <h2>Messages:</h2>
    <ul id="chat"></ul>
  </div>

  <script>
    // -- Read room ID from URL or generate new
    const urlParams = new URLSearchParams(window.location.search);
    let room = urlParams.get('room');
    if (!room) {
      room = Math.random().toString(36).substring(2, 10);
      window.location.search = `?room=${room}`;
    }
    document.getElementById('roomDisplay').textContent = room;

    // -- Setup Pusher
    const pusher = new Pusher('e10c1ec0ce48bfccc178', {
      cluster: 'eu',
    });
    const channel = pusher.subscribe(`room-${room}`);

    channel.bind('message', async function (data) {
      try {
        const secret = document.getElementById('secret').value;
        if (!secret) return;

        const decrypted = await decryptMessage(data.encrypted, secret);
        const parsed = JSON.parse(decrypted);
        const li = document.createElement('li');
        li.innerHTML = `<img src="${parsed.pfp}" width="32" style="vertical-align:middle;"> <b>${parsed.nickname}</b>: ${parsed.text}`;
        document.getElementById('chat').appendChild(li);
      } catch (e) {
        console.warn("Decryption failed or wrong key");
      }
    });

    // -- Handle sending
    document.getElementById('send').onclick = async () => {
      const text = document.getElementById('msg').value;
      const nickname = document.getElementById('nickname').value || "Anonymous";
      const pfp = document.getElementById('pfp').value || "https://placehold.co/32";
      const secret = document.getElementById('secret').value;

      if (!text || !secret) return;

      const payload = { text, nickname, pfp };
      const encrypted = await encryptMessage(JSON.stringify(payload), secret);

      await fetch('/.netlify/functions/pusher-signal', {
        method: 'POST',
        body: JSON.stringify({
          room,
          message: encrypted
        })
      });
      document.getElementById('msg').value = '';
    };

    // -- Room creation
    document.getElementById('createRoom').onclick = () => {
      const newRoom = Math.random().toString(36).substring(2, 10);
      window.location.search = `?room=${newRoom}`;
    };

    // -- Encryption utils
    async function encryptMessage(message, password) {
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password);
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        enc.encode(message)
      );
      return btoa([...iv, ...new Uint8Array(encrypted)].map(b => String.fromCharCode(b)).join(''));
    }

    async function decryptMessage(encoded, password) {
      const data = atob(encoded).split('').map(c => c.charCodeAt(0));
      const iv = new Uint8Array(data.slice(0, 12));
      const encrypted = new Uint8Array(data.slice(12));
      const key = await deriveKey(password);
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        key,
        encrypted
      );
      return new TextDecoder().decode(decrypted);
    }

    async function deriveKey(password) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: enc.encode("fixed_salt"), // Replace with dynamic salt if needed
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }
  </script>
</body>
</html>
