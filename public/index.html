<!DOCTYPE html>
<html>
<head>
  <title>Encrypted WebRTC Chat</title>
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
</head>
<body>
  <h2>Encrypted WebRTC Chat</h2>
  <input id="roomInput" placeholder="Room ID" />
  <input id="keyInput" placeholder="Encryption Key" />
  <button id="joinBtn">Join Room</button>
  <br/><br/>
  <textarea id="chat" rows="10" cols="50" readonly></textarea><br/>
  <input id="msgInput" placeholder="Type a message" />
  <button id="sendBtn">Send</button>

  <script>
    // Your Pusher credentials
    const PUSHER_KEY = 'e10c1ec0ce48bfccc178';
    const PUSHER_CLUSTER = 'eu';

    let pc;
    let dataChannel;
    let pusher, channel;
    let room;
    let encryptionKey;

    // Simple XOR encrypt/decrypt
    function xorEncryptDecrypt(text, key) {
      const textBytes = new TextEncoder().encode(text);
      const keyBytes = new TextEncoder().encode(key);
      const result = textBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
      return new TextDecoder().decode(result);
    }

    // Append messages to chat
    function appendMessage(msg) {
      const chat = document.getElementById('chat');
      chat.value += msg + '\n';
      chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById('joinBtn').onclick = async () => {
      room = document.getElementById('roomInput').value.trim();
      encryptionKey = document.getElementById('keyInput').value;
      if (!room || !encryptionKey) {
        alert('Please enter room ID and encryption key');
        return;
      }

      pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
      channel = pusher.subscribe(`room-${room}`);

      pc = new RTCPeerConnection();

      // Data channel for sending messages (only create on initiator)
      dataChannel = pc.createDataChannel('chat');
      dataChannel.onmessage = e => {
        // Decrypt incoming message
        const decrypted = xorEncryptDecrypt(e.data, encryptionKey);
        appendMessage(`Friend: ${decrypted}`);
      };

      pc.onicecandidate = event => {
        if (event.candidate) {
          sendSignal({ candidate: event.candidate });
        }
      };

      // Handle incoming data channels (for non-initiator)
      pc.ondatachannel = event => {
        dataChannel = event.channel;
        dataChannel.onmessage = e => {
          const decrypted = xorEncryptDecrypt(e.data, encryptionKey);
          appendMessage(`Friend: ${decrypted}`);
        };
      };

      // Listen for signaling messages
      channel.bind('signal', async data => {
        if (!pc) return;

        if (data.sdp) {
          const desc = new RTCSessionDescription(data.sdp);
          if (desc.type === 'offer') {
            // Received offer — set remote description, create answer
            await pc.setRemoteDescription(desc);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendSignal({ sdp: pc.localDescription });
          } else if (desc.type === 'answer') {
            // Received answer — set remote description only if signaling state allows
            if (pc.signalingState === 'have-local-offer') {
              await pc.setRemoteDescription(desc);
            }
          }
        } else if (data.candidate) {
          try {
            await pc.addIceCandidate(data.candidate);
          } catch (e) {
            console.error('Error adding ICE candidate:', e);
          }
        }
      });

      // Create offer (initiator)
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      sendSignal({ sdp: pc.localDescription });

      appendMessage('You joined the room. Start chatting!');

      // Send signaling via your serverless function or Pusher here
      function sendSignal(signalData) {
        fetch('https://jolly-banana-897.netlify.app/.netlify/functions/pusher-signal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room, signalData }),
        }).catch(console.error);
      }
    };

    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !dataChannel || dataChannel.readyState !== 'open') return;
      // Encrypt before sending
      const encrypted = xorEncryptDecrypt(text, encryptionKey);
      dataChannel.send(encrypted);
      appendMessage(`You: ${text}`);
      input.value = '';
    };
  </script>
</body>
</html>
